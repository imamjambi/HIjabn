<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keranjang Belanja - Toko Hijabina</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        body {
            background: #f5f7fa;
        }
        .cart-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }
        .cart-items, .checkout-summary {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .cart-item {
            display: flex;
            gap: 20px;
            padding: 20px 0;
            border-bottom: 1px solid #eee;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
        }
        .cart-item-info {
            flex: 1;
        }
        .cart-item-info h3 {
            margin-bottom: 10px;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        .quantity-control button {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 5px;
        }
        .quantity-control input {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }
        .remove-btn {
            color: #e74c3c;
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 10px;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .summary-total {
            font-size: 1.2em;
            font-weight: bold;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .checkout-form .form-group {
            margin-bottom: 15px;
        }
        .checkout-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .checkout-form input, .checkout-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .btn-checkout {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
        }
        .empty-cart {
            text-align: center;
            padding: 50px;
            color: #999;
        }
        .empty-cart h2 {
            margin-bottom: 20px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #764ba2;
            text-decoration: none;
            font-weight: 600;
        }
        @media (max-width: 992px) {
            .cart-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="cart-container" id="cartContainer">
        <div>
            <a href="user-home.html" class="back-link">‚Üê Kembali Belanja</a>
            <div class="cart-items">
                <h2 style="margin-bottom: 20px;">Keranjang Anda</h2>
                <div id="cartItemsList">
                    <!-- Items will be loaded here -->
                </div>
            </div>
        </div>

        <div class="checkout-summary">
            <h2 style="margin-bottom: 20px;">Ringkasan Pesanan</h2>
            <div id="summaryDetails">
                <div class="summary-row">
                    <span>Subtotal</span>
                    <span id="subtotal">Rp 0</span>
                </div>
                <div class="summary-row">
                    <span>Ongkos Kirim</span>
                    <span id="shippingCost">Rp 10.000</span>
                </div>
                <hr style="border: none; border-top: 1px solid #eee; margin: 15px 0;">
                <div class="summary-row summary-total">
                    <span>Total</span>
                    <span id="totalAmount">Rp 10.000</span>
                </div>
            </div>

            <div class="checkout-form" style="margin-top: 30px;">
                <h3 style="margin-bottom: 20px;">Alamat Pengiriman</h3>
                <form id="checkoutForm">
                    <div class="form-group">
                        <label for="fullName">Nama Lengkap</label>
                        <input type="text" id="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="phone">Nomor Telepon</label>
                        <input type="tel" id="phone" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Alamat Lengkap</label>
                        <textarea id="address" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn-checkout">Buat Pesanan</button>
                </form>
            </div>
        </div>
    </div>

    <div id="emptyCartView" style="display: none; padding: 40px;">
        <div class="empty-cart" style="background: white; border-radius: 15px; padding: 50px;">
            <h2>üõí Keranjang Anda Kosong</h2>
            <p>Sepertinya Anda belum menambahkan produk apapun ke keranjang.</p>
            <a href="user-home.html" class="btn-primary" style="margin-top: 30px; text-decoration: none;">Mulai Belanja</a>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script type="module">
        import { auth, db } from './js/firebase-config.js';

        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    loadCart();
                    // Pre-fill form with user data from firestore
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        document.getElementById('fullName').value = userData.name || '';
                        document.getElementById('phone').value = userData.phone || '';
                    }
                } else {
                    alert('Anda harus login untuk melihat keranjang.');
                    window.location.href = 'login-page.html';
                }
            });

            document.getElementById('checkoutForm').addEventListener('submit', placeOrder);
        });

        function loadCart() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const cartItemsList = document.getElementById('cartItemsList');

            if (cart.length === 0) {
                document.getElementById('cartContainer').style.display = 'none';
                document.getElementById('emptyCartView').style.display = 'block';
                return;
            }

            cartItemsList.innerHTML = '';
            cart.forEach(item => {
                const itemHtml = `
                    <div class="cart-item" id="item-${item.id}">
                        <img src="${item.imageUrl || 'https://via.placeholder.com/100'}" alt="${item.name}" class="cart-item-image">
                        <div class="cart-item-info">
                            <h3>${item.name}</h3>
                            <p>Rp ${item.price.toLocaleString('id-ID')}</p>
                            <div class="quantity-control">
                                <button onclick="updateQuantity('${item.id}', -1)">-</button>
                                <input type="number" value="${item.quantity}" onchange="setQuantity('${item.id}', this.value)">
                                <button onclick="updateQuantity('${item.id}', 1)">+</button>
                            </div>
                        </div>
                        <div>
                            <p style="font-weight: bold;">Rp ${(item.price * item.quantity).toLocaleString('id-ID')}</p>
                            <button class="remove-btn" onclick="removeItem('${item.id}')">Hapus</button>
                        </div>
                    </div>
                `;
                cartItemsList.innerHTML += itemHtml;
            });
            updateSummary();
        }

        function updateCart(cart) {
            localStorage.setItem('cart', JSON.stringify(cart));
            loadCart();
        }

        window.updateQuantity = function(productId, change) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const item = cart.find(i => i.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.id !== productId);
                }
            }
            updateCart(cart);
        }

        window.setQuantity = function(productId, quantity) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            const item = cart.find(i => i.id === productId);
            const newQuantity = parseInt(quantity);
            if (item && newQuantity > 0) {
                item.quantity = newQuantity;
            } else if (item && newQuantity <= 0) {
                cart = cart.filter(i => i.id !== productId);
            }
            updateCart(cart);
        }

        window.removeItem = function(productId) {
            let cart = JSON.parse(localStorage.getItem('cart')) || [];
            cart = cart.filter(i => i.id !== productId);
            updateCart(cart);
        }

        function updateSummary() {
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shippingCost = 10000; // Fixed shipping cost for now
            const total = subtotal + shippingCost;

            document.getElementById('subtotal').textContent = `Rp ${subtotal.toLocaleString('id-ID')}`;
            document.getElementById('shippingCost').textContent = `Rp ${shippingCost.toLocaleString('id-ID')}`;
            document.getElementById('totalAmount').textContent = `Rp ${total.toLocaleString('id-ID')}`;
        }

        async function placeOrder(e) {
            e.preventDefault();
            if (!currentUser) {
                alert('Sesi login tidak valid. Silakan login kembali.');
                return;
            }

            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            if (cart.length === 0) {
                alert('Keranjang Anda kosong.');
                return;
            }

            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const shippingCost = 10000;
            const total = subtotal + shippingCost;

            const orderData = {
                userId: currentUser.uid,
                customerName: document.getElementById('fullName').value,
                customerEmail: currentUser.email,
                customerPhone: document.getElementById('phone').value,
                shippingAddress: document.getElementById('address').value,
                items: cart,
                subtotal: subtotal,
                shippingCost: shippingCost,
                total: total,
                status: 'pending', // Initial status
                paymentMethod: 'COD', // Hardcoded for now
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const orderRef = await db.collection('orders').add(orderData);
                alert(`Pesanan berhasil dibuat! ID Pesanan Anda: ${orderRef.id}`);
                
                // Clear cart
                localStorage.removeItem('cart');
                
                // Redirect to home or an order success page
                window.location.href = 'user-home.html';

            } catch (error) {
                console.error("Error placing order: ", error);
                alert('Gagal membuat pesanan. Silakan coba lagi.');
            }
        }
    </script>
</body>
</html>