import { auth, db } from './firebase-config.js';

// ===== CRITICAL: Prevent Multiple Initializations =====
if (window.dashboardInitialized) {
    console.log('Dashboard already initialized, skipping...');
} else {
    window.dashboardInitialized = true;
    initDashboard();
}

// ===== Store Unsubscribe Functions =====
const unsubscribeFunctions = [];

function initDashboard() {
    console.log('Initializing dashboard...');

    // ===== AUTH CHECK (Only Once) =====
    const unsubAuth = auth.onAuthStateChanged(user => {
        if (!user) {
            window.location.href = 'login-page.html';
            return;
        }

        // Update user info
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userAvatar = document.getElementById('userAvatar');

        if (userName) userName.textContent = user.displayName || 'Admin';
        if (userEmail) userEmail.textContent = user.email;
        if (userAvatar) userAvatar.textContent = (user.displayName || 'Admin')[0].toUpperCase();

        // Load initial data (ONLY ONCE)
        loadDashboardStats();
        loadRecentOrders();
    });
    unsubscribeFunctions.push(unsubAuth);

    // ===== NAVIGATION (One-Time Setup) =====
    setupNavigation();

    // ===== LOGOUT (One-Time) =====
    setupLogout();

    // ===== SETTINGS SAVE =====
    setupSettings();
}

// ===== SETUP NAVIGATION =====
function setupNavigation() {
    const navItems = document.querySelectorAll('.nav-item');
    
    // Remove any existing listeners first
    navItems.forEach(item => {
        const newItem = item.cloneNode(true);
        item.parentNode.replaceChild(newItem, item);
    });

    // Add listeners to fresh elements
    const freshNavItems = document.querySelectorAll('.nav-item');
    freshNavItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            // Remove active from all
            freshNavItems.forEach(i => i.classList.remove('active'));
            
            // Add active to clicked
            this.classList.add('active');

            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

            // Show target section
            const section = this.dataset.section;
            const targetSection = document.getElementById(`${section}-section`);
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Update page title
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) {
                    pageTitle.textContent = this.querySelector('span:last-child').textContent;
                }

                // Load section-specific data
                loadSectionData(section);
            }
        });
    });
}

// ===== SETUP LOGOUT =====
function setupLogout() {
    const logoutBtn = document.getElementById('logoutBtn');
    if (!logoutBtn) return;

    // Remove existing listener
    const newLogoutBtn = logoutBtn.cloneNode(true);
    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

    // Add fresh listener
    document.getElementById('logoutBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (confirm('Apakah Anda yakin ingin logout?')) {
            try {
                // Cleanup listeners
                unsubscribeFunctions.forEach(unsub => unsub());
                await auth.signOut();
                window.location.href = 'login-page.html';
            } catch (error) {
                console.error('Logout error:', error);
                alert('Gagal logout: ' + error.message);
            }
        }
    });
}

// ===== SETUP SETTINGS =====
function setupSettings() {
    const saveBtn = document.getElementById('saveSettingsBtn');
    if (!saveBtn) return;

    // Remove existing listener
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

    // Add fresh listener
    document.getElementById('saveSettingsBtn').addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        const storeName = document.getElementById('storeName').value;
        const storeEmail = document.getElementById('storeEmail').value;
        const storePhone = document.getElementById('storePhone').value;
        const storeAddress = document.getElementById('storeAddress').value;

        try {
            await db.collection('settings').doc('store').set({
                name: storeName,
                email: storeEmail,
                phone: storePhone,
                address: storeAddress,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            alert('Pengaturan berhasil disimpan!');
        } catch (error) {
            console.error('Error saving settings:', error);
            alert('Gagal menyimpan pengaturan: ' + error.message);
        }
    });

    // Load existing settings
    loadSettings();
}

// ===== LOAD SETTINGS =====
async function loadSettings() {
    try {
        const doc = await db.collection('settings').doc('store').get();
        if (doc.exists) {
            const settings = doc.data();
            document.getElementById('storeName').value = settings.name || 'Toko Hijabina';
            document.getElementById('storeEmail').value = settings.email || 'info@tokohijabina.com';
            document.getElementById('storePhone').value = settings.phone || '+62 812-3456-7890';
            document.getElementById('storeAddress').value = settings.address || 'Jl. Contoh No. 123, Jakarta';
        }
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// ===== LOAD SECTION DATA =====
function loadSectionData(section) {
    switch(section) {
        case 'dashboard':
            if (!window.dashboardStatsLoaded) {
                loadDashboardStats();
                loadRecentOrders();
                window.dashboardStatsLoaded = true;
            }
            break;
        case 'products':
            if (!window.productsLoaded) {
                loadProductsData();
                window.productsLoaded = true;
            }
            break;
        case 'orders':
            if (!window.ordersLoaded) {
                loadOrdersData();
                window.ordersLoaded = true;
            }
            break;
        case 'customers':
            if (!window.customersLoaded) {
                loadCustomersData();
                window.customersLoaded = true;
            }
            break;
        case 'reports':
            // Reports loaded by its own script in HTML
            break;
        case 'settings':
            if (!window.settingsLoaded) {
                loadSettings();
                window.settingsLoaded = true;
            }
            break;
    }
}

// ===== DASHBOARD STATS (No Real-Time) =====
async function loadDashboardStats() {
    try {
        // Load once, don't listen for changes
        const ordersSnapshot = await db.collection('orders').get();
        const productsSnapshot = await db.collection('products').get();
        const usersSnapshot = await db.collection('users').get();

        let totalRevenue = 0;
        let completedOrders = 0;
        
        ordersSnapshot.forEach(doc => {
            const order = doc.data();
            if (order.status === 'completed') {
                totalRevenue += order.totalAmount || 0;
                completedOrders++;
            }
        });

        // Update UI
        const revenueEl = document.getElementById('totalRevenue');
        const ordersEl = document.getElementById('totalOrders');
        const productsEl = document.getElementById('totalProducts');
        const customersEl = document.getElementById('totalCustomers');

        if (revenueEl) revenueEl.textContent = formatCurrency(totalRevenue);
        if (ordersEl) ordersEl.textContent = ordersSnapshot.size;
        if (productsEl) productsEl.textContent = productsSnapshot.size;
        if (customersEl) customersEl.textContent = usersSnapshot.size;

    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// ===== RECENT ORDERS (No Real-Time) =====
window.loadRecentOrders = async function() {
    try {
        const tbody = document.querySelector('#recentOrdersTable tbody');
        if (!tbody) return;

        const snapshot = await db.collection('orders')
            .orderBy('createdAt', 'desc')
            .limit(5)
            .get();

        if (snapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">üì≠ Belum ada pesanan</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        snapshot.forEach(doc => {
            const order = doc.data();
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${doc.id.substring(0, 8)}...</td>
                <td>${order.customerName || 'N/A'}</td>
                <td>${formatCurrency(order.totalAmount || 0)}</td>
                <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                <td>${formatDate(order.createdAt)}</td>
            `;
        });
    } catch (error) {
        console.error('Error loading recent orders:', error);
    }
}

// ===== PRODUCTS DATA =====
window.loadProductsData = async function() {
    try {
        const tbody = document.querySelector('#productsTable tbody');
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">‚è≥ Memuat produk...</td></tr>';

        const snapshot = await db.collection('products').get();

        if (snapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">üì¶ Belum ada produk</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        snapshot.forEach(doc => {
            const product = doc.data();
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><img src="${product.imageUrl || 'assets/placeholder.jpg'}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;"></td>
                <td>${product.name}</td>
                <td>${product.category}</td>
                <td>${formatCurrency(product.price)}</td>
                <td>${product.stock}</td>
                <td>
                    <button class="btn-sm btn-edit" onclick="editProduct('${doc.id}')">Edit</button>
                    <button class="btn-sm btn-delete" onclick="deleteProduct('${doc.id}')">Hapus</button>
                </td>
            `;
        });
    } catch (error) {
        console.error('Error loading products:', error);
        const tbody = document.querySelector('#productsTable tbody');
        if (tbody) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #f00;">‚ùå Error: ${error.message}</td></tr>`;
        }
    }
}

// ===== ORDERS DATA =====
window.loadOrdersData = async function() {
    try {
        const tbody = document.querySelector('#ordersTable tbody');
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">‚è≥ Memuat pesanan...</td></tr>';

        const snapshot = await db.collection('orders')
            .orderBy('createdAt', 'desc')
            .get();

        if (snapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">üì¶ Belum ada pesanan</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        snapshot.forEach(doc => {
            const order = doc.data();
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${doc.id.substring(0, 8)}...</td>
                <td>${order.customerName || 'N/A'}</td>
                <td>${formatCurrency(order.totalAmount || 0)}</td>
                <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                <td>${formatDate(order.createdAt)}</td>
                <td>
                    <button class="btn-sm" onclick="viewOrderDetail('${doc.id}')">Detail</button>
                    ${order.status !== 'completed' ? `<button class="btn-sm btn-success" onclick="markOrderAsCompleted('${doc.id}')">Selesai</button>` : ''}
                </td>
            `;
        });
    } catch (error) {
        console.error('Error loading orders:', error);
        const tbody = document.querySelector('#ordersTable tbody');
        if (tbody) {
            tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 40px; color: #f00;">‚ùå Error: ${error.message}</td></tr>`;
        }
    }
}

// ===== CUSTOMERS DATA =====
window.loadCustomersData = async function() {
    try {
        const tbody = document.querySelector('#customersTable tbody');
        if (!tbody) return;

        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">‚è≥ Memuat pelanggan...</td></tr>';

        const snapshot = await db.collection('users').get();

        if (snapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">üë• Belum ada pelanggan</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        
        // Get order count for each customer
        const ordersSnapshot = await db.collection('orders').get();
        const orderCountByEmail = {};
        
        ordersSnapshot.forEach(doc => {
            const order = doc.data();
            const email = order.customerEmail || '';
            orderCountByEmail[email] = (orderCountByEmail[email] || 0) + 1;
        });

        snapshot.forEach(doc => {
            const user = doc.data();
            const orderCount = orderCountByEmail[user.email] || 0;
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${user.name || 'N/A'}</td>
                <td>${user.email || 'N/A'}</td>
                <td>${user.phone || 'N/A'}</td>
                <td>${orderCount}</td>
                <td>${formatDate(user.createdAt)}</td>
            `;
        });
    } catch (error) {
        console.error('Error loading customers:', error);
        const tbody = document.querySelector('#customersTable tbody');
        if (tbody) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 40px; color: #f00;">‚ùå Error: ${error.message}</td></tr>`;
        }
    }
}

// ===== VIEW ORDER DETAIL =====
window.viewOrderDetail = async function(orderId) {
    const modal = document.getElementById('orderDetailModal');
    const loading = document.getElementById('modalLoading');
    const details = document.getElementById('modalOrderDetails');
    
    if (!modal) return;
    
    modal.style.display = 'flex';
    if (loading) loading.style.display = 'block';
    if (details) details.style.display = 'none';

    try {
        const doc = await db.collection('orders').doc(orderId).get();
        
        if (!doc.exists) {
            alert('Pesanan tidak ditemukan!');
            modal.style.display = 'none';
            return;
        }

        const order = doc.data();

        document.getElementById('modalOrderId').textContent = orderId.substring(0, 8) + '...';
        document.getElementById('modalCustomerName').textContent = order.customerName || 'N/A';
        document.getElementById('modalTotalItems').textContent = order.items ? order.items.length : 0;
        document.getElementById('modalOrderDate').textContent = formatDate(order.createdAt);
        document.getElementById('modalOrderStatus').textContent = order.status;

        const itemsBody = document.getElementById('modalOrderItems');
        itemsBody.innerHTML = '';
        
        if (order.items && order.items.length > 0) {
            order.items.forEach(item => {
                itemsBody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.quantity}x</td>
                        <td>${formatCurrency(item.price * item.quantity)}</td>
                    </tr>
                `;
            });
            itemsBody.innerHTML += `
                <tr style="font-weight: bold; background: #f9fafb;">
                    <td colspan="2" style="text-align: right;">Total:</td>
                    <td>${formatCurrency(order.totalAmount || 0)}</td>
                </tr>
            `;
        } else {
            itemsBody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px;">Tidak ada item</td></tr>';
        }

        if (loading) loading.style.display = 'none';
        if (details) details.style.display = 'block';
    } catch (error) {
        console.error('Error loading order detail:', error);
        alert('Gagal memuat detail pesanan: ' + error.message);
        modal.style.display = 'none';
    }
}

// ===== EDIT PRODUCT (Placeholder) =====
window.editProduct = function(productId) {
    alert('Fitur edit produk akan segera hadir!\nID Produk: ' + productId);
    // TODO: Implement edit product modal or redirect to edit page
}

// ===== DELETE PRODUCT =====
window.deleteProduct = async function(productId) {
    if (!confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
        return;
    }

    try {
        await db.collection('products').doc(productId).delete();
        alert('Produk berhasil dihapus!');
        
        // Reload products
        window.productsLoaded = false;
        loadProductsData();
    } catch (error) {
        console.error('Error deleting product:', error);
        alert('Gagal menghapus produk: ' + error.message);
    }
}

// ===== UTILITY FUNCTIONS =====
function formatCurrency(amount) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(amount || 0);
}

function formatDate(timestamp) {
    if (!timestamp) return '-';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);
    return date.toLocaleDateString('id-ID', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// ===== CLEANUP ON PAGE UNLOAD =====
window.addEventListener('beforeunload', () => {
    unsubscribeFunctions.forEach(unsub => {
        try {
            unsub();
        } catch (e) {
            console.error('Error unsubscribing:', e);
        }
    });
});

// ===== MODAL CLOSE ON OUTSIDE CLICK =====
window.addEventListener('click', (e) => {
    const modal = document.getElementById('orderDetailModal');
    if (modal && e.target === modal) {
        modal.style.display = 'none';
    }
});

console.log('Dashboard script loaded successfully!');